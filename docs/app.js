(()=>{var D=()=>{let e={},i={modkeys:[],map:{}},n="",l=[];function h(r){if(l.length>3){l=[];return}let d=r.code,p=parseInt(r.key);Number.isNaN(p)||(d="Digit"),l.push(d);let g=l.join(" "),b=i.map[g];b&&(b(p)&&r.preventDefault(),l=l.filter(F=>F[0]=="*")),i.modkeys.includes(d)&&(l=[`*${d}`])}function m(r){let d;i.modkeys.includes(r.code)?(d=`-*${r.code}`,l=l.filter(g=>g!=`*${r.code}`)):(d=`-${r.code}`,l=l.filter(g=>g!=r.code));let p=i.map[d];p&&(r.preventDefault(),p()),l=l.filter(g=>g.includes("*"))}function a(){l=[]}return document.addEventListener("keydown",h),document.addEventListener("keyup",m),document.addEventListener("blur",a),{addControlMap:(r,d)=>{let p=new Array;for(let[g]of Object.entries(d)){let b=g.match(/(?<=\*)(.*?)(?=\ )/gm);b&&b.length&&!p.includes(b[0])&&p.push(b[0])}e[r]={modkeys:p,map:d}},removeControlMap:r=>{e[r]&&delete e[r]},setControlMap:(r,d=!1)=>{if(r=="")return i={modkeys:new Array,map:{}},n="",d&&(l=[]),!0;let p=e[r];return p?(i=p,n=r,d&&(l=[]),!0):!1},getControlMap:r=>e[r].map||null,get activeControlMap(){return n},close:()=>{document.removeEventListener("keydown",h),document.removeEventListener("keyup",m),document.removeEventListener("blur",a)}}};var L=[{label:"Hobbiton",pos:[1e3,750],img:"hobbiton",detail:"A village in the Shire."},{label:"Bree",pos:[1196,684],img:"bree",detail:"A village in Bree-land."},{label:"Rivendell",pos:[1703,671],img:"rivendell",detail:"An elven outpost in the Misty Mountains."},{label:"Moria Gate",pos:[1689,885],img:"moria-gate",detail:"The original entrance to Moria, a.k.a. Khazad-d\xFBm."},{label:"Isengard",pos:[1523,1306],img:"isengard",detail:"The fortress of Saruman."},{label:"Fangorn",pos:[1740,1237],img:"fangorn",detail:"A dark woodland below the Misty Mountains"},{label:"Helm's Deep",pos:[1656,1474],img:"helms-deep",detail:"The location of the fortress known as the Hornburg."},{label:"Lorien",pos:[1823,1039],img:"lorien",detail:"A forest, home to a kingdom of wood-elves."},{label:"Erebor: The Lonely Mountain",pos:[2294,446],img:"erebor",detail:"The former home of Smaug the dragon."},{label:"Minas Tirith",pos:[2225,1704],img:"minas-tirith",detail:"Home to the king of Gondor."},{label:"Barad-d\xFBr",pos:[2552,1631],img:"barad-dur",detail:"Sauron's central stronghold in Mordor."},{label:"Dead Marshes",pos:[2184,1524],img:"dead-marshes",detail:"A network of stagnant pools and soft mires."}];var c={},w=[],t,P,S,T,u,f,v=0,y=0,E=100,A=.3,I=2.5,o=.6,H=20,s,C,R=-1;(async()=>(await z(),W(),N(),j()))();async function z(){let e=["map","pin","pinuser"];for(let i of e){let n=await fetch(`assets/${i}.png`);c[i]=await createImageBitmap(await n.blob())}}function W(){u=document.getElementsByClassName("chart-detail")[0],u.querySelector(".x").addEventListener("click",()=>{u.style.display="none";for(let e of s)e.opacity=1}),f=document.getElementsByClassName("chart-detail editable")[0],f.querySelector(".x").addEventListener("click",()=>{f.style.display="none";for(let e of s)e.opacity=1}),f.querySelector("input").addEventListener("input",e=>{s[R].label=e.target.value})}function N(){t=document.querySelector("canvas");let e=t.parentElement.clientWidth,i=t.parentElement.clientHeight;P=t.getBoundingClientRect(),t.width=e*window.devicePixelRatio,t.height=i*window.devicePixelRatio,t.style.width=`${e}px`,t.style.height=`${i}px`;let n=t.transferControlToOffscreen();S=new Worker("cnv-worker.js"),S.postMessage({msg:"init",offscreenCnv:n,assets:c},[n]),s=L.map(a=>({default:!0,label:a.label,pos:[a.pos[0],a.pos[1]],hitPos:[a.pos[0],a.pos[1]-c.pin.height/o/2],opacity:1})),C=L.map(a=>({detail:a.detail,img:a.img}));let l=!1,h=!1,m=-1;T=D(),T.addControlMap("chart",{ArrowUp:()=>(M(0,-E),!0),ArrowDown:()=>(M(0,E),!0),ArrowLeft:()=>(M(-E,0),!0),ArrowRight:()=>(M(E,0),!0),"*ShiftLeft ArrowUp":()=>{k(1)},"*ShiftLeft ArrowDown":()=>{k(-1)},ShiftLeft:()=>{h=!0},"-*ShiftLeft":()=>{h=!1}}),w.push({element:t,listener:"mousedown",fn:a=>{l=!0,t.style.cursor="move"}}),w.push({element:t,listener:"mousemove",fn:a=>{if(l)M(-a.movementX*1.5/o,-a.movementY*1.5/o),u.style.opacity=".4",f.style.opacity=".4";else{let r=x(a.clientX,a.clientY);m=K(r[0],r[1]),m>-1?t.style.cursor="pointer":t.style.cursor="default"}}}),w.push({element:t,listener:"wheel",fn:a=>{a.preventDefault(),a.deltaY>1?k(-1):k(1)}}),w.push({element:document.body,listener:"mouseup",fn:a=>{l=!1,u.style.opacity="1",f.style.opacity="1",t.style.cursor="default"}}),w.push({element:document.body,listener:"mouseleave",fn:a=>{l=!1,u.style.opacity="1",h=!1,t.style.cursor="default"}}),w.push({element:t,listener:"click",fn:a=>{if(h){for(let d of s)d.opacity=.6;let r=x(a.clientX,a.clientY);O(r[0],r[1])}else if(m>-1){for(let r of s)r.opacity=.6;s[m].opacity=1,_(m)}}})}function j(){document.querySelector(".load").style.display="none",t.style.display="block",T.setControlMap("chart");for(let n of w)n.element.addEventListener(n.listener,n.fn);let e=80;for(let n of s)n.pos[1]-=e,n.opacity=0;let i=window.setInterval(()=>{for(let n of s)n.pos[1]+=2,n.opacity+=.02;e-=2,e==0&&window.clearInterval(i)},1);M(0,0),window.requestAnimationFrame(q)}function M(e,i){v+=e,v<=0?c.map.width*o<t.width?v=-((t.width-c.map.width*o)/2/o):v=0:v>c.map.width-t.width/o&&(v=c.map.width-t.width/o),y+=i,y<0?c.map.height*o<t.height?y=-((t.height-c.map.height*o)/2/o):y=0:y>c.map.height-t.height/o&&(y=c.map.height-t.height/o)}function k(e){let i=o;if(e>0){if(o==I)return;o=o+.1>I?I:o+.1}else{if(o==A)return;o=o-.1<A?A:o-.1}v+=(t.width-t.width/o)/2-(t.width-t.width/i)/2,y+=(t.height-t.height/o)/2-(t.height-t.height/i)/2;for(let n of s)n.hitPos[1]=n.pos[1]-c.pin.height/o/2;M(0,0)}function x(e,i){return[Math.round(((e-P.left)*window.devicePixelRatio+v*o)/o),Math.round(((i-P.top)*window.devicePixelRatio+y*o)/o)]}function K(e,i){for(let n=0;n<s.length;n++)if(!(Math.abs(s[n].hitPos[0]-e)>H)&&!(Math.abs(s[n].hitPos[1]-i)>H))return n;return-1}function O(e,i){let n={default:!1,label:`Location ${s.filter(m=>!m.default).length+1}`,pos:[e,i],hitPos:[e,i-c.pin.height/o/2],opacity:0};s.push(n),C.push({detail:"",img:""});let l=80;n.pos[1]-=l;let h=window.setInterval(()=>{n.pos[1]+=2,n.opacity+=.02,l-=2,l==0&&window.clearInterval(h)},1);_(s.length-1)}function q(){S.postMessage({msg:"draw",x:v,y,z:o,pins:s}),window.requestAnimationFrame(q)}function _(e){if(s[e].default)f.style.display="none",u.querySelector(".image").src=`assets/${C[e].img}.png`,u.querySelector("h1").innerText=s[e].label,u.querySelector("p").innerText=C[e].detail,u.style.display="flex";else{u.style.display="none",R=e,f.querySelector(".image").src="assets/imguser.png",f.style.display="flex";let i=f.querySelector("input");i.value=s[e].label,i.focus()}}})();
